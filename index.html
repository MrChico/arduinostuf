<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <meta name="rnbo-version" content="1.0.0-alpha.5">
    <title>Pendulum</title>
</head>

<body>
  <div class="slidecontainer">
    <input type="range" min="1" max="10" value="2" class="slider" id="wind">
  </div>
  <div class="slidecontainer">
    <input type="range" min="0" max="0.001" step="0.00001" value="0.00004" class="slider" id="gravity">
  </div>
  <noscript>You need to enable JavaScript to run this app.</noscript>
    <div class="rnbo-root">
	<div>
		<h1 id="patcher-title">Pendulum</h1>
	</div>
        <div id="rnbo-clickable-keyboard">
            <h2>MIDI Keyboard</h2>
            <em id="no-midi-label">No MIDI input</em>
        </div>
        <div id="rnbo-inports">
            <h2>Inports</h2>
            <em id="no-inports-label">No inports available</em>
            <form id="inport-form" className="inport">
                <div className="inport-input">
                    <select id="inport-select"></select>
                    <input id="inport-text" type="text"></input>
                    <input id="inport-submit" className="smallButton" type="submit" value="Send"/>
                </div>
            </form>1
        </div>
		<div id="rnbo-console">
			<h2>Outports</h2>
			<em id="no-outports-label">No outports available</em>
			<div id="rnbo-console-div">
				<p id="rnbo-console-readout">Waiting for messages...</p>
				<em id="rnbo-console-description">Check the developer console for more messages from the RNBO device</em>
			</div>
		</div>
		<div id="rnbo-presets">
			<h2>Presets</h2>
			<em id="no-presets-label">No presets defined</em>
			<select id="preset-select"></select>
		</div>
        <div id="rnbo-parameter-sliders">
            <h2>Parameters</h2>
            <em id="no-param-label">No parameters</em>
        </div>
    </div>
    <!-- Load the script that creates the RNBO device  -->
    <!-- Uncomment if you know the version of your exported RNBO patch to avoid dynamic loading -->
    <!-- <script type="text/javascript" src="https://cdn.cycling74.com/rnbo/latest/rnbo.min.js"></script> -->

    <!-- (Optional) The guardrails.js script isn't required for RNBO to work, and you can skip including it -->
    <!-- It simply offers some helpful error messages for common problems -->
    <script type="text/javascript" src="js/guardrails.js"></script>

    <!-- Import RNBO Engine Wrapper -->
    <!-- Make sure to include the RNBO engine version to the version of your exported code, found in rnbopackage.json -->
    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script>
    <style>
      .rnbo-root {
	  display: none;
      }
      .interface {
	  display: none;
      }
      * {
	  margin: 0;
      }
      canvas {
	  cursor: none;
      }
    </style>

    <script>
      //util

      function reviver(key, value) {
	  if(typeof value === 'object' && value !== null) {
	      if (value.dataType === 'Map') {
	return new Map(value.value);
	      }
	  }
	  return value;
      }


    
      let pitch = 0;
      let roll = 0;
      let yaw = 0;
      var socket = io();
      socket.on('gyro', function(msg) {
	  console.log('received msg from server')
	  console.log(msg);
	  pitch = msg.pitch;
	  roll = msg.roll;
	  yaw = msg.yaw;
      });

      let positions = [];
      let t = 0;
      let num = 200;
      let radius = 200;
      let wind = 2;
      let gravity = 0.00004;
      let initialPositions = [];

      
      function setup() {
 	  let c = createCanvas(windowWidth, windowHeight, WEBGL);
	  for (let i = 0; i < num; i++) {
  	      let r = (1 / sqrt(random())) * radius;
  	      let theta = random(TWO_PI);
  	      let x = cos(theta) * r;
  	      let y = sin(theta) * r;
  	      let z = random() * 2;
  	      positions.push({"x": x, "y": y, "z": z});
	      initialPositions.push({"x": x, "y": y, "z": z});
          }
      }
      function windowResized() {
 	  resizeCanvas(windowWidth, windowHeight);
      }

      var windslider = document.getElementById("wind");

      windslider.oninput = function() {
	  socket.emit("windchange", this.value);
	  wind = this.value;
      }

      socket.on("wind", function(newVal) {
	  windslider.value = newVal;
	  wind = newVal;
      })

      var gravityslider = document.getElementById("gravity");
      gravityslider.oninput = function() {
	  socket.emit("gravitychange", this.value);
	  gravity = this.value;
      }

      socket.on("gravity", function(newVal) {
	  gravityslider.value = newVal;
	  gravity = newVal;
      })
      
      window.addEventListener('mousemove', trackPos)

      let mouseY = 0;
      let mouseX = 0;
      function trackPos(e) {
	  mouseY = e.clientY;
	  mouseX = e.clientX;
      }
      let r = Math.floor(Math.random() * 255);
      let g = 150 + Math.floor(Math.random() * 100);
      let b = 150 + Math.floor(Math.random() * 100);

      let mice = new Map();
      socket.on("mice", function(ms) {
	  let m = new Map();
	  m = JSON.parse(ms, reviver)
	  m.delete(r + g + b);
	  mice = m;
      })
      
      var sendCursor = setInterval(function() {
	  socket.emit("mouse", mouseX, mouseY, r, g, b);
      }, 20);

      console.log(r);
      
      function draw() {
	  angleMode(DEGREES);
	  background(0);
	  let xAxis = createVector(1,0,0);
	  let yAxis = createVector(0,1,0);
	  let zAxis = createVector(0,0,1);
	  rotate(pitch, xAxis);
	  rotate(roll,  yAxis);
	  rotate(yaw,   zAxis);
	  push();
	  t += 0.01;
	  for (let i = 0; i < num; i++) {
	      let x = positions[i].x;
	      let y = positions[i].y;
	      let distance = sqrt(x ** 2 + y ** 2);
	      if (Number.isNaN(x) || Number.isNaN(y) || y == 0 || x == 0) {
		  positions[i].x = initialPositions[i].x;
		  positions[i].y = initialPositions[i].y;
	      } else {
		  positions[i].x = x - gravity * x * distance
		      + wind * (sqrt(distance - radius)) * (noise(t, i) - .5);
		  positions[i].y = y - gravity * y * distance
		      + wind * (sqrt(distance - radius)) * (noise(t + 5, i) - .5);
	      }
	      strokeWeight((noise(t, i) * 8 + 3));
	      stroke('white')
	      point(positions[i].x, positions[i].y, positions[i].z);
	  }
	  camera(200, 200, 200);
	  pop();
	  loop();
	  // our pointer:
	  strokeWeight(15);
	  stroke(r,g,b)
	  point(mouseX - windowWidth / 2, mouseY -  windowHeight / 2);
	  // other pointers
	  mice.forEach(v => {
	      strokeWeight(10);
	      console.log('colors')
	      console.log('r: ' + v.r);
	      stroke(v.r, v.g, v.b)
	      point(v.mx - windowWidth / 2, v.my -  windowHeight / 2);
	  })
      }

    </script>
</body>
</html>
